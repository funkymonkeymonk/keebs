---
name: Build Failure Handler

on:
  workflow_run:
    workflows:
      - Build
    types:
      - completed
    branches:
      - main

jobs:
  handle-failure:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get workflow run details
        id: workflow-details
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get the workflow run details including jobs
            const runDetails = await github.rest.actions.listJobsForWorkflowRun({
              owner: owner,
              repo: repo,
              run_id: workflowRun.id,
            });

            // Get failed jobs and their logs
            const failedJobs = runDetails.data.jobs.filter(job => job.conclusion === 'failure');
            let errorDetails = '';

            for (const job of failedJobs) {
              const jobLogs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                owner: owner,
                repo: repo,
                job_id: job.id,
              });

              errorDetails += '\n## Failed Job: ' + job.name + '\n';
              errorDetails += '**Status**: ' + job.conclusion + '\n';
              errorDetails += '**Started**: ' + job.started_at + '\n';
              errorDetails += '**Completed**: ' + job.completed_at + '\n\n';
              errorDetails += '### Error Logs:\n```\n' + jobLogs.data + '\n```\n\n';
            }

            return {
              workflowName: workflowRun.name,
              runId: workflowRun.id,
              runNumber: workflowRun.run_number,
              branch: workflowRun.head_branch,
              commitSha: workflowRun.head_sha,
              commitMessage: workflowRun.head_commit.message,
              actor: workflowRun.head_commit.author.name,
              errorDetails: errorDetails,
              workflowUrl: workflowRun.html_url
            };

      - name: Create issue for build failure
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const details = ${{ steps.workflow-details.outputs.result }};
            const workflowDetails = JSON.parse(details);

            const issueTitle = 'ðŸš¨ Build Failure - ' + workflowDetails.workflowName + ' #' + workflowDetails.runNumber;

            const issueBody = '## Build Failure Detected\n\n' +
              '**Workflow**: ' + workflowDetails.workflowName + '\n' +
              '**Run ID**: ' + workflowDetails.runId + '\n' +
              '**Run Number**: #' + workflowDetails.runNumber + '\n' +
              '**Branch**: ' + workflowDetails.branch + '\n' +
              '**Commit**: ' + workflowDetails.commitSha + '\n' +
              '**Author**: ' + workflowDetails.actor + '\n' +
              '**Commit Message**: ' + workflowDetails.commitMessage + '\n\n' +
              '**Workflow URL**: ' + workflowDetails.workflowUrl + '\n\n' +
              '## Error Details\n' + workflowDetails.errorDetails + '\n\n' +
              '## Next Steps\n' +
              'The OpenCode action has been triggered to diagnose and attempt to fix this issue.\n\n' +
              '/oc investigate build failure and propose fixes';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'build-failure', 'automated']
            });

            console.log('Created issue #' + issue.data.number);

            // Output the issue number for the next step
            console.log('::set-output name=issue_number::' + issue.data.number);
            return issue.data.number;

      - name: Trigger OpenCode analysis
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};

            if (issueNumber) {
              // Create a comment to trigger OpenCode
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '/oc investigate build failure and propose fixes'
              });

              console.log('Triggered OpenCode on issue #' + issueNumber);
            } else {
              console.log('Could not find the created issue to trigger OpenCode');
            }
